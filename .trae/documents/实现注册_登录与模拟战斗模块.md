## 总体目标
- 增加注册与登录功能（后端写死默认用户，不接数据库），登录后在右上角显示默认头像和用户名。
- 新增“模拟战斗”模块，含前端对战界面与后端战斗计算接口，遵循准备回合与战斗回合优先级规则与胜负条件。

## 前端改动
1. 路由与菜单
- 新增路由：`/login`、`/register`、`/battle`（修改 `frontend/src/router/index.js`）。
- 在侧边菜单新增“模拟战斗”（修改 `frontend/src/App.vue:1`，在菜单下新增同级模块）。

2. 顶部用户信息展示
- 在 `frontend/src/App.vue:20` 的 `<el-header>` 右侧新增用户区：显示默认头像与用户名，提供下拉菜单“退出登录”。
- 未登录时显示“未登录”和“去登录”按钮；登录后显示头像与用户名。

3. 登录与注册页
- 新增 `Login.vue` 与 `Register.vue`（`frontend/src/views/auth/`）：使用 Element Plus 表单（用户名、密码），表单校验；调用后端接口。
- 登录成功：存储 `token` 与 `username` 至 `localStorage`；刷新头部用户区显示。
- 注册成功：给出成功提示后可直接登录或返回登录页。

4. Axios 注入令牌
- 在 `frontend/src/api/index.js:1` 的请求拦截器中读取 `localStorage.token`，注入 `Authorization: Bearer <token>`。

5. 模拟战斗界面
- 新增 `frontend/src/views/battle/BattleSim.vue`：
  - 左右两列分别为队伍一与队伍二，每队3名武将：1主将、2副将；左侧主将最左，右侧主将最右。
  - 每个武将卡：展示立绘，左上角覆盖显示阵营，靠近下侧边缘显示星级；立绘下方依次排列三个战法选择框，第一个固定为自带战法不可选，其余两个可选战法来自后端列表。
  - 两队中间显示大写“VS”。
  - 底部“开始战斗”按钮，点击后调用后端 `/api/battle/simulate`，在右侧/下方显示战报日志与结果。
- 数据源：武将与战法列表直接复用已有 API（`frontend/src/api/general.js` 与 `frontend/src/api/skill.js`）。

## 后端改动
1. 认证接口
- 新增 `server/api/auth_api.py` 与 `init_auth_api(api)` 并在 `server/run.py:1` 注册：
  - `POST /api/auth/login`：入参 `{username, password}`；校验默认三用户 `jenuos`、`caocao`、`weini`，密码均为 `123`；成功返回 `{token, username, avatarUrl}`，其中 `token` 为 `mock-token-<username>`。
  - `POST /api/auth/register`：入参 `{username, password}`；若用户名未使用则加入进程内用户字典并返回成功（不持久化）；若冲突返回错误。
  - `GET /api/auth/me`：从 `Authorization` 解析用户名并返回用户信息（用于前端刷新头像与用户名）。

2. 战斗接口
- 新增 `server/api/battle_api.py` 与 `server/services/battle_service.py`：
  - `POST /api/battle/simulate`：入参为两个队伍的武将与对应战法信息，输出战斗日志与胜负。
  - 规则实现：
    - 战斗共 1 个准备回合 + 8 个战斗回合。
    - 准备回合优先级：`兵种 > 阵法 > 被动 > 指挥`，同优先级按武将 `speed` 决定先手。
    - 战斗回合在上述基础上新增：`主动 > 突击 > 普通攻击`，整体顺序为 `兵种 > 阵法 > 被动 > 指挥 > 主动 > 突击 > 普通攻击`。
    - 初始兵力：双方每名武将均为 `10000`；任意一方主将兵力为 `0` 则该方战败。
  - 伤害/效果简化方案（首版可运行）：
    - 若战法 `effectTypes` 包含“兵刃”，按武将 `power` 计算；包含“谋略”按 `intelligence` 计算；否则默认按 `power`。
    - 触发率取 `impactFactors[0].triggerRate` 作为概率，伤害系数取 `impactFactors[0].coefficients[0]`，伤害 `= 基础属性 * 系数`（后续可按技能等级/品质细化）。
    - 普通攻击伤害 `= power * 常数系数`（如 `10`）。
    - 生成详细战报：包含回合、出手顺序、是否触发、伤害值、剩余兵力、击杀事件等。

## 数据结构约定
- `/api/battle/simulate` 请求体示例：
```json
{
  "team1": {
    "generals": [
      { "cfgId": 100001, "name": "主将A", "faction": "魏", "stars": 5, "power": 90, "intelligence": 70, "speed": 80, "innateSkillId": 200001,
        "skills": [{"cfgId": 200001}, {"cfgId": 200010}, {"cfgId": 200015}] },
      { "cfgId": 100002, ... },
      { "cfgId": 100003, ... }
    ],
    "chiefIndex": 0
  },
  "team2": {
    "generals": [ { ... }, { ... }, { ... } ],
    "chiefIndex": 2
  }
}
```
- 后端可按 `cfgId` 关联技能详情（`triggerType`、`effectTypes`、`impactFactors`），或直接由前端把必要字段一并传入。
- 响应包含：`winner`、`finalTroops`（双方三人兵力）、`rounds`、`log`（事件列表）。

## 验证与交互
- 启动后端 `server/run.py:28`（`http://localhost:5000`），前端 `vite` 代理已配置 `frontend/vite.config.js:1`。
- 登录后顶部显示默认头像与用户名；可退出登录。
- 模拟战斗界面可选择武将与战法，点击“开始战斗”，展示战报与结果。

## 变更文件清单（示例）
- 修改：`frontend/src/App.vue:1`、`frontend/src/api/index.js:1`、`frontend/src/router/index.js`
- 新增：`frontend/src/views/auth/Login.vue`、`frontend/src/views/auth/Register.vue`、`frontend/src/views/battle/BattleSim.vue`
- 新增：`server/api/auth_api.py`、`server/api/battle_api.py`、`server/services/battle_service.py`
- 修改：`server/run.py:1`（注册新接口）

## 注意事项
- 注册新增用户仅进程内有效，服务重启后丢失；满足“先写死，后续接数据库”的要求，后续再接入持久化。
- 伤害公式为首版简化实现，用于验证流程与交互；可在后续版本引入更精细的系数、状态、目标选择与抗性。

请确认以上方案，确认后我将开始具体改造并提交代码变更。